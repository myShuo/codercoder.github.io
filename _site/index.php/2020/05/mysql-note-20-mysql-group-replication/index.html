<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<title>MySQL手记20 &#8212; MySQL Group Replication(MGR组复制) | codercoder</title>

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>MySQL手记20 — MySQL Group Replication(MGR组复制) | codercoder</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="MySQL手记20 — MySQL Group Replication(MGR组复制)" />
<meta name="author" content="Shuo" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="MGR（MySQL Group Replication）是MySQL原生的数据库集群架构，底层使用Paxos协议实现多写、选举等过程，MySQL官方也在不断添加相应的内容，使MGR更加可控稳定。可配合Router、ProxySQL进行使用。" />
<meta property="og:description" content="MGR（MySQL Group Replication）是MySQL原生的数据库集群架构，底层使用Paxos协议实现多写、选举等过程，MySQL官方也在不断添加相应的内容，使MGR更加可控稳定。可配合Router、ProxySQL进行使用。" />
<link rel="canonical" href="http://localhost:4000/index.php/2020/05/mysql-note-20-mysql-group-replication/" />
<meta property="og:url" content="http://localhost:4000/index.php/2020/05/mysql-note-20-mysql-group-replication/" />
<meta property="og:site_name" content="codercoder" />
<meta property="og:image" content="http://codercoder.cn/wp-content/uploads/2020/05/2020-05-2789.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-27T18:55:03+08:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/index.php/2020/05/mysql-note-20-mysql-group-replication/","headline":"MySQL手记20 — MySQL Group Replication(MGR组复制)","dateModified":"2020-05-27T18:55:03+08:00","datePublished":"2020-05-27T18:55:03+08:00","image":"http://codercoder.cn/wp-content/uploads/2020/05/2020-05-2789.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/index.php/2020/05/mysql-note-20-mysql-group-replication/"},"author":{"@type":"Person","name":"Shuo"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.png"},"name":"Shuo"},"description":"MGR（MySQL Group Replication）是MySQL原生的数据库集群架构，底层使用Paxos协议实现多写、选举等过程，MySQL官方也在不断添加相应的内容，使MGR更加可控稳定。可配合Router、ProxySQL进行使用。","@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/assets/images/logo.png" alt="codercoder">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/about">About</a>
                </li>
                
                
                
                
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/categories#Tech">Tech (53)</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/categories#Fell-in-pit">Fell-in-pit (21)</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/categories#LOL-7788">LOL-7788 (2)</a>
                    </li>
                    
                
                
            

                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">codercoder</h1>
    <p class="lead">
        DBA(Database Administrator), we can share and discuss MySQL, MongoDB, Redis and other databases here, also including learning Python, Shell, Golang together.
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=MySQL手记20 &#8212; MySQL Group Replication(MGR组复制)&url=http://localhost:4000/index.php/2020/05/mysql-note-20-mysql-group-replication/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=http://localhost:4000/index.php/2020/05/mysql-note-20-mysql-group-replication/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/index.php/2020/05/mysql-note-20-mysql-group-replication/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
    
    <div class="sep">
    </div>
    <ul>
        <li>
        <a class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="/assets/images/avatar.png" alt="Shuo">
                        
                    </div>
                    <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                        <a target="_blank" class="link-dark" href="http://codercoder.cn">Shuo</a><a target="_blank" href="" class="btn follow">Follow</a>
                        <span class="author-description">I' a DBA(Database Administrator), we can share and discuss MySQL, MongoDB, Redis and other databases here, also including learning Python, Shell, Golang together.</span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">MySQL手记20 &#8212; MySQL Group Replication(MGR组复制)</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid" src="http://codercoder.cn/wp-content/uploads/2020/05/2020-05-2789.png" alt="MySQL手记20 &#8212; MySQL Group Replication(MGR组复制)">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                <!-- End Toc -->
                <h1 id="一简介">一、简介</h1>

<p>MGR（MySQL Group Replication）是MySQL原生的数据库集群架构，底层使用Paxos协议实现多写、选举等过程，目前最大支持9个节点。可分为单写（Single-Primary）、多写（Multiple-Primary）两类集群，虽然能够多写，但是还是建议单写，因为多写需要有选举的过程，在节点较多、或者网络环境较差的情况下，会严重影响性能。官方work有相关的测试报告：http://mysqlhighavailability.com/zooming-in-on-group-replication-performance/<br />
<img src="http://codercoder.cn/wp-content/uploads/2020/05/2020-05-2789.png" alt="" /></p>

<h1 id="二安装部署">二、安装部署</h1>

<h2 id="1数据库配置">（1）数据库配置</h2>

<p>在启动前，需要修改启动的配置文件：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>#gtid
gtid_mode=on
enforce_gtid_consistency=on
binlog_checksum=none
transaction_write_set_extraction    = XXHASH64
loose-group_replication_group_name  = "8cb61fd9-8931-11ea-ad6f-0242ac110003"
loose_group_replication_single_primary_mode = 0    #0:single-primary; 1:multiple-primary
loose-group_replication_start_on_boot = OFF
loose_group_replication_compression_threshold = 100
loose_group_replication_flow_control_mode = 0
loose-group_replication_bootstrap_group = OFF
loose_group_replication_enforce_update_everywhere_checks =true   #single-primary需设为关闭，multiple-primary则必须打开，主要是使（serialized隔离级别的事务，或者是使事务中有外键关系的表的）事务失败
loose-group_replication_transaction_size_limit = 10485760     #事务的大小，若太大，则会影响集群的性能
loose_group_replication_unreachable_majority_timeout = 120
loose-group_replication_auto_increment_increment = 7   #自增值的跨度大小
loose-group_replication_local_address="172.21.0.2:15501"    #当前主机的ip，可动态修改
loose-group_replication_group_seeds='172.21.0.2:15501,172.21.0.4:15503,172.21.0.3:15502'   ##集群中所有节点的信息，可动态修改
loose_group_replication_ip_whitelist='172.21.0.4,172.21.0.2,172.21.0.3'  #节点的ip白名单，可动态修改

</pre></td></tr></tbody></table></code></pre></div></div>

<p>其中loose开头的为group replication安装插件时候启动的配置。MGR不支持binlog_checksum，切gtid必须打开。</p>

<h2 id="2添加插件">（2）添加插件</h2>

<p>Group Replication是以插件的形式加入到集群中的，所以需要进行插件的安装：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>mysql&gt; INSTALL PLUGIN group_replication SONAME 'group_replication.so';
​
mysql&gt; SHOW PLUGINS;
+---------------------------------+----------+--------------------+----------------------+---------+
| Name                            | Status   | Type               | Library              | License |
+---------------------------------+----------+--------------------+----------------------+---------+
...
| group_replication               | ACTIVE   | GROUP REPLICATION  | group_replication.so | GPL     |
+---------------------------------+----------+--------------------+----------------------+---------+

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="a-启动第一个节点">a. 启动第一个节点</h3>

<p>第一个节点启动时，需要先设置：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>SET GLOBAL group_replication_bootstrap_group=ON;

</pre></td></tr></tbody></table></code></pre></div></div>

<p>即表示该节点为运行集群中的第一个节点，启动Group Replication：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>START GROUP_REPLICATION;

</pre></td></tr></tbody></table></code></pre></div></div>

<p>日志中打印的信息为：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>[System] [MY-010597] [Repl] 'CHANGE MASTER TO FOR CHANNEL 'group_replication_applier' executed'. Previous state master_host='&lt;NULL&gt;', master_port= 0, master_log_file='', master_log_pos= 4, master_bind=''. New state master_host='&lt;NULL&gt;', master_port= 0, master_log_file='', master_log_pos= 4, master_bind=''.

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="b-启动第二个节点">b .启动第二个节点</h3>

<p>在第二个节点执行：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>START GROUP_REPLICATION;

</pre></td></tr></tbody></table></code></pre></div></div>

<p>由于集群中已经有第一个节点，所以不需要再设置group_replication_bootstrap_group=on<br />
日志：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>[System] [MY-010597] [Repl] 'CHANGE MASTER TO FOR CHANNEL 'group_replication_applier' executed'. Previous state master_host='&lt;NULL&gt;', master_port= 0, master_log_file='', master_log_pos= 4, master_bind=''. New state master_host='&lt;NULL&gt;', master_port= 0, master_log_file='', master_log_pos= 4, master_bind=''.
[System] [MY-010597] [Repl] 'CHANGE MASTER TO FOR CHANNEL 'group_replication_recovery' executed'. Previous state master_host='&lt;NULL&gt;', master_port= 0, master_log_file='', master_log_pos= 4, master_bind=''. New state master_host='70b353672cdc', master_port= 5501, master_log_file='', master_log_pos= 4, master_bind=''.
[Warning] [MY-010897] [Repl] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the 'START SLAVE Syntax' in the MySQL Manual for more information.
2020-05-22T07:34:16.119089-00:00 27 [System] [MY-010562] [Repl] Slave I/O thread for channel 'group_replication_recovery': connected to master 'root@70b353672cdc:5501',replication started in log 'FIRST' at position 4
[System] [MY-010597] [Repl] 'CHANGE MASTER TO FOR CHANNEL 'group_replication_recovery' executed'. Previous state master_host='70b353672cdc', master_port= 5501, master_log_file='', master_log_pos= 4, master_bind=''. New state master_host='&lt;NULL&gt;', master_port= 0, master_log_file='', master_log_pos= 4, master_bind=''.

</pre></td></tr></tbody></table></code></pre></div></div>

<p>查看第二个节点的添加情况：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>mysql&gt; select * from performance_schema.replication_group_members;
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST  | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
| group_replication_applier | e3f0850e-8936-11ea-98ba-0242ac150004 | 2bd38a52527e |        5502 | ONLINE       | PRIMARY     | 8.0.20         |
| group_replication_applier | e4a14f46-8936-11ea-b379-0242ac150005 | 70b353672cdc |        5501 | ONLINE       | PRIMARY     | 8.0.20         |
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
2 rows in set (0.00 sec)

</pre></td></tr></tbody></table></code></pre></div></div>

<p>重启group replication时，状态为RECOVERY:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>mysql&gt; select * from performance_schema.replication_group_members;
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST  | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
| group_replication_applier | e3f0850e-8936-11ea-98ba-0242ac150004 | 2bd38a52527e |        5502 | RECOVERING   | PRIMARY     | 8.0.20         |
| group_replication_applier | e4a14f46-8936-11ea-b379-0242ac150005 | 70b353672cdc |        5501 | ONLINE       | PRIMARY     | 8.0.20         |
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
2 rows in set (0.03 sec)

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="c-添加第三个节点">c. 添加第三个节点</h3>

<p>直接执行start group_replication;，打印日志为：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>[Warning] [MY-011735] [Repl] Plugin group_replication reported: '[GCS] Automatically adding IPv4 localhost address to the whitelist. It is mandatory that it is added.'
[Warning] [MY-011735] [Repl] Plugin group_replication reported: '[GCS] Automatically adding IPv6 localhost address to the whitelist. It is mandatory that it is added.'
[System] [MY-010597] [Repl] 'CHANGE MASTER TO FOR CHANNEL 'group_replication_applier' executed'. Previous state master_host='&lt;NULL&gt;', master_port= 0, master_log_file='', master_log_pos= 4, master_bind=''. New state master_host='&lt;NULL&gt;', master_port= 0, master_log_file='', master_log_pos= 4, master_bind=''.
[System] [MY-010597] [Repl] 'CHANGE MASTER TO FOR CHANNEL 'group_replication_recovery' executed'. Previous state master_host='&lt;NULL&gt;', master_port= 0, master_log_file='', master_log_pos= 4, master_bind=''. New state master_host='70b353672cdc', master_port= 5501, master_log_file='', master_log_pos= 4, master_bind=''.
[Warning] [MY-010897] [Repl] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the 'START SLAVE Syntax' in the MySQL Manual for more information.
[System] [MY-010562] [Repl] Slave I/O thread for channel 'group_replication_recovery': connected to master 'root@70b353672cdc:5501',replication started in log 'FIRST' at position 4
[System] [MY-010597] [Repl] 'CHANGE MASTER TO FOR CHANNEL 'group_replication_recovery' executed'. Previous state master_host='70b353672cdc', master_port= 5501, master_log_file='', master_log_pos= 4, master_bind=''. New state master_host='&lt;NULL&gt;', master_port= 0, master_log_file='', master_log_pos= 4, master_bind=''.

</pre></td></tr></tbody></table></code></pre></div></div>

<p>通过以上的日志可以看出，在各个节点启动的时候，均会有CHANGE MASTER TO FOR CHANNEL …的操作。</p>

<p>完成后，查看集群中节点的状态，查看集群的状态：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>mysql&gt; SELECT * FROM performance_schema.replication_group_members;
​
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST  | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
| group_replication_applier | e0dd6e3d-8936-11ea-9176-0242ac150003 | 7bcecb1807d5 |        5503 | ONLINE       | PRIMARY     | 8.0.20         |
| group_replication_applier | e3f0850e-8936-11ea-98ba-0242ac150004 | 2bd38a52527e |        5502 | ONLINE       | PRIMARY     | 8.0.20         |
| group_replication_applier | e4a14f46-8936-11ea-b379-0242ac150005 | 70b353672cdc |        5501 | ONLINE       | PRIMARY     | 8.0.20         |
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
3 rows in set (0.02 sec)

</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="三mgr相关参数">三、MGR相关参数</h1>

<p>MGR为了保证数据的一致性以及提升集群的性能，用户可进行相关的配置，当前版本8.0.20：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="rouge-code"><pre>mysql&gt; show variables like '%group_repl%';
+-----------------------------------------------------+----------------------------------------------------+
| Variable_name                                       | Value                                              |
+-----------------------------------------------------+----------------------------------------------------+
| group_replication_allow_local_lower_version_join    | OFF                                                |
| group_replication_auto_increment_increment          | 7                                                  |
| group_replication_autorejoin_tries                  | 0                                                  |
| group_replication_bootstrap_group                   | OFF                                                |
| group_replication_clone_threshold                   | 9223372036854775807                                |
| group_replication_communication_debug_options       | GCS_DEBUG_NONE                                     |
| group_replication_communication_max_message_size    | 10485760                                           |
| group_replication_components_stop_timeout           | 31536000                                           |
| group_replication_compression_threshold             | 100                                                |
| group_replication_consistency                       | EVENTUAL                                           |
| group_replication_enforce_update_everywhere_checks  | ON                                                 |
| group_replication_exit_state_action                 | READ_ONLY                                          |
| group_replication_flow_control_applier_threshold    | 25000                                              |
| group_replication_flow_control_certifier_threshold  | 25000                                              |
| group_replication_flow_control_hold_percent         | 10                                                 |
| group_replication_flow_control_max_quota            | 0                                                  |
| group_replication_flow_control_member_quota_percent | 0                                                  |
| group_replication_flow_control_min_quota            | 0                                                  |
| group_replication_flow_control_min_recovery_quota   | 0                                                  |
| group_replication_flow_control_mode                 | DISABLED                                           |
| group_replication_flow_control_period               | 1                                                  |
| group_replication_flow_control_release_percent      | 50                                                 |
| group_replication_force_members                     |                                                    |
| group_replication_group_name                        | 8cb61fd9-8931-11ea-ad6f-0242ac110003               |
| group_replication_group_seeds                       | 172.21.0.2:15501,172.21.0.4:15503,172.21.0.3:15502 |
| group_replication_gtid_assignment_block_size        | 1000000                                            |
| group_replication_ip_whitelist                      | 172.21.0.4,172.21.0.2,172.21.0.3,172.21.0.5        |
| group_replication_local_address                     | 172.21.0.3:15502                                   |
| group_replication_member_expel_timeout              | 0                                                  |
| group_replication_member_weight                     | 50                                                 |
| group_replication_message_cache_size                | 1073741824                                         |
| group_replication_poll_spin_loops                   | 0                                                  |
| group_replication_recovery_complete_at              | TRANSACTIONS_APPLIED                               |
| group_replication_recovery_compression_algorithms   | uncompressed                                       |
| group_replication_recovery_get_public_key           | OFF                                                |
| group_replication_recovery_public_key_path          |                                                    |
| group_replication_recovery_reconnect_interval       | 60                                                 |
| group_replication_recovery_retry_count              | 10                                                 |
| group_replication_recovery_ssl_ca                   |                                                    |
| group_replication_recovery_ssl_capath               |                                                    |
| group_replication_recovery_ssl_cert                 |                                                    |
| group_replication_recovery_ssl_cipher               |                                                    |
| group_replication_recovery_ssl_crl                  |                                                    |
| group_replication_recovery_ssl_crlpath              |                                                    |
| group_replication_recovery_ssl_key                  |                                                    |
| group_replication_recovery_ssl_verify_server_cert   | OFF                                                |
| group_replication_recovery_tls_ciphersuites         |                                                    |
| group_replication_recovery_tls_version              | TLSv1,TLSv1.1,TLSv1.2,TLSv1.3                      |
| group_replication_recovery_use_ssl                  | OFF                                                |
| group_replication_recovery_zstd_compression_level   | 3                                                  |
| group_replication_single_primary_mode               | OFF                                                |
| group_replication_ssl_mode                          | DISABLED                                           |
| group_replication_start_on_boot                     | OFF                                                |
| group_replication_transaction_size_limit            | 10485760                                           |
| group_replication_unreachable_majority_timeout      | 120                                                |
+-----------------------------------------------------+----------------------------------------------------+
55 rows in set (0.12 sec)

</pre></td></tr></tbody></table></code></pre></div></div>

<p>其中：<br />
<strong>group_replication_enforce_update_everywhere_checks=ON</strong><br />
 该MGR集群为multiple-primary，即多主的集群，其中较为重要的参数配置：<br />
<strong>group_replication_consistency=EVENTUAL</strong><br />
 事务一致性等级配置，本实例的配置为：在执行”读”或者”写”事务之前，不用等待之前的事务完成。即看到的是其它事务开始前的快照。<br />
 使用EVENTUAL，由于不需要进行等待其它事务的完成，所以可以获得较高的性能。当然，为了得到更高的事务一致性，还有其它配置可供选择，并且支持session级别的修改。<br />
http://codercoder.cn/index.php/2019/09/innodb-cluster-mgr-group_replication_consistency/<br />
<strong>group_replication_exit_state_action=READ_ONLY</strong><br />
 从8.0.12开始加入该参数，节点非正常退出集群后记性的操作，非正常退出，包括：异常退出、由于网络等其它问题重试group_replication_autorejoin_tries次数之后，还是未能重新加入集群。为了防止异常的节点还能被访问，或者重新加入集群后影响正常的数据。所以提供此参数进行配置。</p>

<p>集群的基本连接信息，也可在实例启动后通过<strong>set global xxx</strong>进行配置：<br />
<strong>group_replication_start_on_boot</strong><br />
 是否自动启动group_replication<br />
<strong>group_replication_group_name</strong><br />
 当前集群的名称<br />
<strong>group_replication_group_seeds</strong><br />
 集群中的节点信息<br />
<strong>group_replication_ip_whitelist</strong><br />
 节点所在机器的ip白名单<br />
<strong>group_replication_local_address</strong><br />
 当前节点的地址</p>

<h1 id="四mgr相关表">四、MGR相关表</h1>

<p>MGR相关的表，是存储在performance_schema库下的，两张表：<br />
<strong>replication_group_members</strong>：用以存储MGR集群的节点信息<br />
<strong>replication_group_member_stats</strong>：用以存储节点的状态信息，执行的事务数等</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>mysql&gt; use performance_schema
Database changed
​
mysql&gt; show tables like '%group%';
+----------------------------------------+
| Tables_in_performance_schema (%group%) |
+----------------------------------------+
| replication_group_member_stats         |
| replication_group_members              |
+----------------------------------------+
2 rows in set (0.00 sec)

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="1replication_group_members表">（1）replication_group_members表</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>mysql&gt; select * from replication_group_members ;
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST  | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
| group_replication_applier | e0dd6e3d-8936-11ea-9176-0242ac150003 | 7bcecb1807d5 |        5503 | ONLINE       | PRIMARY     | 8.0.20         |
| group_replication_applier | e3f0850e-8936-11ea-98ba-0242ac150004 | 2bd38a52527e |        5502 | ONLINE       | PRIMARY     | 8.0.20         |
| group_replication_applier | e4a14f46-8936-11ea-b379-0242ac150005 | 70b353672cdc |        5501 | ONLINE       | PRIMARY     | 8.0.20         |
+---------------------------+--------------------------------------+--------------+-------------+--------------+-------------+----------------+
3 rows in set (0.01 sec)

</pre></td></tr></tbody></table></code></pre></div></div>

<p>可以看出，该MGR集群一共三个节点，并且均为PRIMARY，MEMBER_STATE均为ONLINE状态，即三个节点均在正常运行。其中：MEMBER_HOST显示了三个节点的hostname，MEMBER_PORT为对应的端口。</p>

<h2 id="2replication_group_member_stats表">（2）replication_group_member_stats表</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>mysql&amp;gt; show create table replication_group_member_stats \G
*************************** 1. row ***************************
       Table: replication_group_member_stats
Create Table: CREATE TABLE if not exists `replication_group_member_stats` (
  `CHANNEL_NAME` char(64) NOT NULL,
  `VIEW_ID` char(60) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL,
  `MEMBER_ID` char(36) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL,
  `COUNT_TRANSACTIONS_IN_QUEUE` bigint unsigned NOT NULL,
  `COUNT_TRANSACTIONS_CHECKED` bigint unsigned NOT NULL,
  `COUNT_CONFLICTS_DETECTED` bigint unsigned NOT NULL,
  `COUNT_TRANSACTIONS_ROWS_VALIDATING` bigint unsigned NOT NULL,
  `TRANSACTIONS_COMMITTED_ALL_MEMBERS` longtext NOT NULL,
  `LAST_CONFLICT_FREE_TRANSACTION` text NOT NULL,
  `COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE` bigint unsigned NOT NULL,
  `COUNT_TRANSACTIONS_REMOTE_APPLIED` bigint unsigned NOT NULL,
  `COUNT_TRANSACTIONS_LOCAL_PROPOSED` bigint unsigned NOT NULL,
  `COUNT_TRANSACTIONS_LOCAL_ROLLBACK` bigint unsigned NOT NULL
) ENGINE=PERFORMANCE_SCHEMA DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci

</pre></td></tr></tbody></table></code></pre></div></div>

<p>各个字段的介绍：<br />
 <strong>CHANNEL_NAME</strong>：Name of the Group Replication channel<br />
 各个节点的名称<br />
 <strong>VIEW_ID</strong>：Current view identifier for this group.<br />
 当前MGR集群的view id<br />
 <strong>MEMBER_ID</strong>：The member server UUID. This has a different value for each member in the group. This also serves as a key because it is unique to each member.<br />
 不同成员的UUID，每个集群中的成员UUID唯一<br />
 <strong>COUNT_TRANSACTIONS_IN_QUEUE</strong>：The number of transactions in the queue pending conflict detection checks. Once the transactions have been checked for conflicts, if they pass the check, they are queued to be applied as well.<br />
 队列中等待冲突检测检查的事务数。一旦检查了事务是否存在冲突，待通过检查，则将它们排队等待应用。<br />
 <strong>COUNT_TRANSACTIONS_CHECKED</strong>：The number of transactions that have been checked for conflicts.<br />
 已检查有冲突的事务数。<br />
 <strong>COUNT_CONFLICTS_DETECTED</strong>：The number of transactions that have not passed the conflict detection check.<br />
 尚未通过冲突检测检查的事务数。<br />
 <strong>COUNT_TRANSACTIONS_ROWS_VALIDATING</strong>： Number of transaction rows which can be used for certification, but have not been garbage collected. Can be thought of as the current size of the conflict detection database against which each transaction is certified.<br />
 可以用于认证但尚未被垃圾回收的交易行数。可以认为是每个事务都针对其进行认证的冲突检测数据库的当前大小。<br />
 <strong>TRANSACTIONS_COMMITTED_ALL_MEMBERS</strong>：The transactions that have been successfully committed on all members of the replication group, shown as GTID Sets. This is updated at a fixed time interval.<br />
 在复制组的所有成员上已成功提交的事务，显示为 GTID Sets。这将以固定的时间间隔进行更新。<br />
 <strong>LAST_CONFLICT_FREE_TRANSACTION</strong>：The transaction identifier of the last conflict free transaction which was checked.<br />
 最后检查的无冲突交易的交易标识符。<br />
 <strong>COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE</strong>：The number of transactions that this member has received from the replication group which are waiting to be applied.<br />
 该成员已从复制组收到的等待应用的事务数。<br />
 <strong>COUNT_TRANSACTIONS_REMOTE_APPLIED</strong>：Number of transactions this member has received from the group and applied.<br />
 该成员已从该组收到并应用的交易数。<br />
 <strong>COUNT_TRANSACTIONS_LOCAL_PROPOSED</strong>：Number of transactions which originated on this member and were sent to the group.<br />
 起源于此成员并发送到该组的交易数量。<br />
 <strong>COUNT_TRANSACTIONS_LOCAL_ROLLBACK</strong>：Number of transactions which originated on this member and were rolled back by the group.<br />
 该成员发起并被该组回滚的事务数。</p>

<p>ps.注意：不能在replication_group_member_stats表上执行truncate table 命令。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>mysql&amp;gt; select * from replication_group_member_stats;
+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+---------------------------------------------------------------------------------------------------------------------+-----------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+
| CHANNEL_NAME              | VIEW_ID             | MEMBER_ID                            | COUNT_TRANSACTIONS_IN_QUEUE | COUNT_TRANSACTIONS_CHECKED | COUNT_CONFLICTS_DETECTED | COUNT_TRANSACTIONS_ROWS_VALIDATING | TRANSACTIONS_COMMITTED_ALL_MEMBERS                                                                                  | LAST_CONFLICT_FREE_TRANSACTION          | COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE | COUNT_TRANSACTIONS_REMOTE_APPLIED | COUNT_TRANSACTIONS_LOCAL_PROPOSED | COUNT_TRANSACTIONS_LOCAL_ROLLBACK |
+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+---------------------------------------------------------------------------------------------------------------------+-----------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+
| group_replication_applier | 15903747614426007:3 | e0dd6e3d-8936-11ea-9176-0242ac150003 |                           0 |                        167 |                        0 |                                  1 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:1-43:1000020-1000167:2000020-2000037,
e4a14f46-8936-11ea-b379-0242ac150005:1-5 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:43 |                                          0 |                                21 |                               146 |                                 0 |
| group_replication_applier | 15903747614426007:3 | e3f0850e-8936-11ea-98ba-0242ac150004 |                           0 |                        167 |                        0 |                                  1 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:1-43:1000020-1000167:2000020-2000037,
e4a14f46-8936-11ea-b379-0242ac150005:1-5 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:43 |                                          0 |                               151 |                                17 |                                 0 |
| group_replication_applier | 15903747614426007:3 | e4a14f46-8936-11ea-b379-0242ac150005 |                           0 |                        167 |                        0 |                                  1 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:1-43:1000020-1000167:2000020-2000037,
e4a14f46-8936-11ea-b379-0242ac150005:1-5 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:43 |                                          0 |                               166 |                                 4 |                                 0 |
+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+---------------------------------------------------------------------------------------------------------------------+-----------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+
3 rows in set (0.00 sec)

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="3replication_group_member_stats表字段分类">（3）replication_group_member_stats表字段分类</h2>

<p>可以简单把replication_group_member_stats表的字段分为两类：</p>

<h3 id="a-基础信息">a. 基础信息</h3>

<p>查看replication_group_member_stats表的数据情况：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>mysql&amp;gt; select CHANNEL_NAME,VIEW_ID,MEMBER_ID,TRANSACTIONS_COMMITTED_ALL_MEMBERS from replication_group_member_stats;
+---------------------------+---------------------+--------------------------------------+-------------------------------------------------------------------------------------------------------------+
| CHANNEL_NAME              | VIEW_ID             | MEMBER_ID                            | TRANSACTIONS_COMMITTED_ALL_MEMBERS                                                                          |
+---------------------------+---------------------+--------------------------------------+-------------------------------------------------------------------------------------------------------------+
| group_replication_applier | 15903747614426007:3 | e0dd6e3d-8936-11ea-9176-0242ac150003 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:1-39:1000020-1000021:2000020,
e4a14f46-8936-11ea-b379-0242ac150005:1-5 |
| group_replication_applier | 15903747614426007:3 | e3f0850e-8936-11ea-98ba-0242ac150004 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:1-39:1000020-1000021:2000020,
e4a14f46-8936-11ea-b379-0242ac150005:1-5 |
| group_replication_applier | 15903747614426007:3 | e4a14f46-8936-11ea-b379-0242ac150005 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:1-39:1000020-1000021:2000020,
e4a14f46-8936-11ea-b379-0242ac150005:1-5 |
+---------------------------+---------------------+--------------------------------------+-------------------------------------------------------------------------------------------------------------+
3 rows in set (0.00 sec)

</pre></td></tr></tbody></table></code></pre></div></div>

<p>这几个字段展示了CHANNEL_NAME、成员信息、当前已提交的事务id。均属于基础信息类。</p>

<h2 id="b计数类">b.计数类</h2>

<p>查看当前状态：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>mysql&amp;gt; select MEMBER_ID,COUNT_TRANSACTIONS_IN_QUEUE,COUNT_TRANSACTIONS_CHECKED,COUNT_CONFLICTS_DETECTED,COUNT_TRANSACTIONS_ROWS_VALIDATING,LAST_CONFLICT_FREE_TRANSACTION,COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE,COUNT_TRANSACTIONS_REMOTE_APPLIED,COUNT_TRANSACTIONS_LOCAL_PROPOSED,COUNT_TRANSACTIONS_LOCAL_ROLLBACK from replication_group_member_stats;
+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+----------------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+
| MEMBER_ID                            | COUNT_TRANSACTIONS_IN_QUEUE | COUNT_TRANSACTIONS_CHECKED | COUNT_CONFLICTS_DETECTED | COUNT_TRANSACTIONS_ROWS_VALIDATING | LAST_CONFLICT_FREE_TRANSACTION               | COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE | COUNT_TRANSACTIONS_REMOTE_APPLIED | COUNT_TRANSACTIONS_LOCAL_PROPOSED | COUNT_TRANSACTIONS_LOCAL_ROLLBACK |
+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+----------------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+
| e0dd6e3d-8936-11ea-9176-0242ac150003 |                           0 |                        166 |                        0 |                                 18 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:2000037 |                                          0 |                                20 |                               146 |                                 0 |
| e3f0850e-8936-11ea-98ba-0242ac150004 |                           0 |                        166 |                        0 |                                 18 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:2000037 |                                          0 |                               150 |                                17 |                                 0 |
| e4a14f46-8936-11ea-b379-0242ac150005 |                           0 |                        166 |                        0 |                                 18 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:2000037 |                                          0 |                               166 |                                 3 |                                 0 |
+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+----------------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+
3 rows in set (0.01 sec)

</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>在5501节点（member_id=e4a14f46-8936-11ea-b379-0242ac150005）插入一条数据</strong>，再次查看：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>mysql&amp;gt; insert into t2 values(6);
Query OK, 1 row affected (0.04 sec)
​
mysql&amp;gt; select MEMBER_ID,COUNT_TRANSACTIONS_IN_QUEUE,COUNT_TRANSACTIONS_CHECKED,COUNT_CONFLICTS_DETECTED,COUNT_TRANSACTIONS_ROWS_VALIDATING,LAST_CONFLICT_FREE_TRANSACTION,COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE,COUNT_TRANSACTIONS_REMOTE_APPLIED,COUNT_TRANSACTIONS_LOCAL_PROPOSED,COUNT_TRANSACTIONS_LOCAL_ROLLBACK from replication_group_member_stats;
+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+----------------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+
| MEMBER_ID                            | COUNT_TRANSACTIONS_IN_QUEUE | COUNT_TRANSACTIONS_CHECKED | COUNT_CONFLICTS_DETECTED | COUNT_TRANSACTIONS_ROWS_VALIDATING | LAST_CONFLICT_FREE_TRANSACTION               | COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE | COUNT_TRANSACTIONS_REMOTE_APPLIED | COUNT_TRANSACTIONS_LOCAL_PROPOSED | COUNT_TRANSACTIONS_LOCAL_ROLLBACK |
+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+----------------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+
| e0dd6e3d-8936-11ea-9176-0242ac150003 |                           0 |                        167 |                        0 |                                 19 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:2000037 |                                          0 |                                21 |                               146 |                                 0 |
| e3f0850e-8936-11ea-98ba-0242ac150004 |                           0 |                        167 |                        0 |                                 19 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:43      |                                          0 |                               151 |                                17 |                                 0 |
| e4a14f46-8936-11ea-b379-0242ac150005 |                           0 |                        167 |                        0 |                                 19 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:2000037 |                                          0 |                               166 |                                 4 |                                 0 |
+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+----------------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+
3 rows in set (0.01 sec)

</pre></td></tr></tbody></table></code></pre></div></div>

<p>过一段时间，再次查询：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>mysql&amp;gt; select MEMBER_ID,COUNT_TRANSACTIONS_IN_QUEUE,COUNT_TRANSACTIONS_CHECKED,COUNT_CONFLICTS_DETECTED,COUNT_TRANSACTIONS_ROWS_VALIDATING,LAST_CONFLICT_FREE_TRANSACTION,COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE,COUNT_TRANSACTIONS_REMOTE_APPLIED,COUNT_TRANSACTIONS_LOCAL_PROPOSED,COUNT_TRANSACTIONS_LOCAL_ROLLBACK from replication_group_member_stats;
+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+-----------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+
| MEMBER_ID                            | COUNT_TRANSACTIONS_IN_QUEUE | COUNT_TRANSACTIONS_CHECKED | COUNT_CONFLICTS_DETECTED | COUNT_TRANSACTIONS_ROWS_VALIDATING | LAST_CONFLICT_FREE_TRANSACTION          | COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE | COUNT_TRANSACTIONS_REMOTE_APPLIED | COUNT_TRANSACTIONS_LOCAL_PROPOSED | COUNT_TRANSACTIONS_LOCAL_ROLLBACK |
+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+-----------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+
| e0dd6e3d-8936-11ea-9176-0242ac150003 |                           0 |                        167 |                        0 |                                  1 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:43 |                                          0 |                                21 |                               146 |                                 0 |
|  e3f0850e-8936-11ea-98ba-0242ac150004 |                           0 |                        167 |                        0 |                                  1 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:43 |                                          0 |                               151 |                                17 |                                 0 |
| e4a14f46-8936-11ea-b379-0242ac150005 |                           0 |                        167 |                        0 |                                  1 | 8cb61fd9-8931-11ea-ad6f-0242ac110003:43 |                                          0 |                               166 |                                 4 |                                 0 |
+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+-----------------------------------------+--------------------------------------------+-----------------------------------+-----------------------------------+-----------------------------------+

</pre></td></tr></tbody></table></code></pre></div></div>

<p>可以看到：<br />
 <strong>COUNT_TRANSACTIONS_IN_QUEUE</strong>： 三个节点+1<br />
 <strong>COUNT_TRANSACTIONS_LOCAL_PROPOSED</strong>：5501加1（由于事务从5501发出），其它节点不变<br />
 <strong>COUNT_TRANSACTIONS_REMOTE_APPLIED</strong>：5502、5503均加1，两个节点均为接收5501节点的事务<br />
 <strong>COUNT_TRANSACTIONS_ROWS_VALIDATING</strong>：三节点均+1<br />
 Number of transaction rows which can be used for certification, but have not been garbage collected. Can be thought of as the current size of the conflict detection database against which each transaction is certified.<br />
 未被GC的用以冲突检测的事务行数，该值会按照一定频率清零（已执行完成的事务，writeset存储在certification_info的数据结构中，而每当事务结束后，各个节点会每隔（在MySQL社区版中broadcast_gtid_executed_period_var硬编码为）60秒广播一次自己节点的gtid_executed。延续阅读：https://zhuanlan.zhihu.com/p/55323854）。<br />
\</p>

<div class="wp-video" style="width: 1280px;"><video class="wp-video-shortcode" controls="controls" height="720" id="video-1123-3" preload="metadata" width="1280"><source src="http://codercoder.cn/wp-content/uploads/2020/05/2020-06-0154.mp4?_=3" type="video/mp4" />&lt;/source&gt;&lt;http://codercoder.cn/wp-content/uploads/2020/05/2020-06-0154.mp4&gt;</video></div>
<p>[/video] # 三、MGR_ProxySQL</p>

<p>了解了MGR的集群后，还需要在该集群上进行代理的搭建，以便于读写及宕机等情况的调度，完成高可用。常用的解决方案有：ProxySQL和MySQL Router。现简单介绍下ProxySQL+MGR：<br />
<img src="http://codercoder.cn/wp-content/uploads/2020/05/2020-05-2481.png" alt="" /><br />
 即：ProxySQL作为数据库集群的代理，Client通过连接ProxySQL访问数据库，ProxySQL则按照配置的规则，将请求分发到不同的MySQL实例，而ProxySQL后端的MySQL实例，为原生的MGR集群。ProxySQL可查阅：<a href="http://codercoder.cn/index.php/2020/05/mysql-note19-mysql-proxy-tool-proxysql/">MySQL手记19 — MySQL代理工具ProxySQL</a><br />
效果为：<br />
<img src="http://codercoder.cn/wp-content/uploads/2020/05/2020-06-0143.png" alt="" /></p>

<h1 id="小结">小结</h1>

<p>对于MGR高可用的架构，5.7后的讨论声越来越多，值得我们逐渐在生产环境中使用。MySQL官方也在不断添加相应的内容，使MGR更加可控稳定，例如group_replication_exit_state_action为了让事务的控制更为精细，group_replication_consistency让集群更稳定…再配合着代理，能够让宕机、网络差、读写切换等运维操作更加方便。(http://codercoder.cn/index.php/2020/05/mysql-note19-mysql-proxy-tool-proxysql/)）。</p>

<p>欢迎关注公众号：<strong>朔的话</strong>：<br />
<img src="http://codercoder.cn/wp-content/uploads/2020/04/2020-04-2693.jpg" alt="" /></p>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2020-05-27">27 May 2020</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Tech">Tech</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/tags#MySQL手记">#MySQL手记</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/tags#Tech">#Tech</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="//index.php/2020/05/mysql-note19-mysql-proxy-tool-proxysql/"> &laquo; MySQL手记19 &#8212; MySQL代理工具ProxySQL</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="//index.php/2020/06/pic_to_db/">如何将图片导入到Oracle数据库 &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'demowebsite'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>


    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#Tech">Tech (53)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Fell-in-pit">Fell-in-pit (21)</a>
                
                    <a class="mt-1 mb-1" href="/categories#LOL-7788">LOL-7788 (2)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2023 codercoder 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a href="http://www.beian.miit.gov.cn/">浙ICP备19037887号
                </a>
                <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010302003390"  style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="/assets/images/beian.png" style="float:left;"/>
                </a>
                <a style="height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">浙公网安备 33010302003390号</a>
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>



<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//demowebsite.disqus.com/count.js"></script>


</body>
</html>
